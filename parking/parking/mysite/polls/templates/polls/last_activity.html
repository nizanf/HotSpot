<!DOCTYPE html>
<html>

<head>
  <!-- <meta charset="UTF-8"> -->
	<title>Last Activity</title>
	<meta charset="utf-8">
	

	<script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.2.1.min.js"></script>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.6/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js"></script>
  
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
	<style>
	.checked {
		color: orange;
	}
	</style>

  <!-- <script src='http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script> -->
  

</head>

<body>
	<div class="all_site">
	{% load static %}
	<link rel="stylesheet" type="text/css" href="{% static "polls/_css/History.css" %}">
    
     
    <div class="body">
        <header>
            <div class="logo">
                <img src="{% static "_images/cars.jpg" %}" height="49"/>          
            </div>
            <nav>
                <ul>
                    <a href="{% url 'polls:homepage' %}"><li>Homepage</li></a>
                    <a href="{% url 'polls:logout' %}"><li>Log Out</li></a>  
                    <!-- TODO GO BACK TO THE LAST PAGE   -->
                </ul>
            </nav>
        </header>  	
  <h2>History</h2>
  <div class = "pull-right">
	<span class="fa fa-star checked"></span>
	<span class="fa fa-star checked"></span>
	<span class="fa fa-star checked"></span>
	<span class="fa fa-star"></span>
	<span class="fa fa-star"></span>
  </div>
  <p></p>         
  <table class="table table-dark">
    <thead>
      <tr>

	<th>Buyer</th>
	<th>Seller</th>
	<th>Date&Time</th>
	<th>Status</th>
	<th>Address</th>
	<th>Contact</th>
	<th>Pincode</th>

      </tr>
    </thead>
    <tbody>




      		<tr>
        		<td id="buyer">{{last_activity.0}}</td>
        		<td id="seller">{{last_activity.1}}</td>
        		<td id="date">{{last_activity.2}}</td>
        		<td id="status">{{last_activity.3}}</td>
        		<td id="address">{{last_activity.4}}</td>
        		<td id="contact">{{last_activity.5}}</td>
        		<td id="pincode">{{last_activity.6}}</td>
      		</tr>      

    </tbody>
  </table>
</div>



			<button type="button" id ='pincode_button' onclick = showButton() >Enter Pincode</button>
			<input type="text" name ='pincode_text' id='pincode_text'/><button onclick = autPincode() type=button" name='aut_pincode' id='aut_pincode'>submit</button>
		





			<button type="button" id="cancel_button" onclick = cancelPurchase() >Cancel</button>




<script>

	window.onload = function() {

		var purchase_id = '{{last_activity.7}}';

		var pincode_text = document.getElementById('pincode_text');
		pincode_text.style.visibility = "hidden";

		var aut_pincode = document.getElementById('aut_pincode');
		aut_pincode.style.visibility = "hidden";


		var status = document.getElementById('status').innerHTML;

		if (status == "done" || status == "canceled"){

			var cancle_button = document.getElementById('cancel_button');
			
			cancle_button.style.visibility = "hidden";

		}

		var pincode_button = document.getElementById('pincode_button');

		var buyer_name = '{{last_activity.0}}';

		if  (buyer_name =="Me"){ // buyer shoul not enter pincode
			pincode_button.style.visibility = "hidden";
		}

		var pincode = document.getElementById('pincode').innerHTML;

		if (pincode == "" ){//in seller
			if (status != "in process"){

				pincode_button.style.visibility = "hidden";
			}

		}
	};


	function cancelPurchase(){

		var purchase_id = '{{last_activity.7}}';

		if ('{{last_activity.1}}' == "Me"){
			var current_url  = "/seller_cancel_parking/"
		} else {
			var current_url  = "/buyer_cancel_parking/"
		}

		$.ajax({
			type: "POST",

			url:current_url,
	
			data: { 'csrfmiddlewaretoken': '{{csrf_token}}', 'purchase_id':purchase_id}, 
			dataType: 'json',
			async: false,
			success : function(data) {
				alert(data.msg)
		
				document.getElementById('status').innerHTML = "canceled";

				var cancle_button = document.getElementById('cancel_button');
				cancle_button.style.visibility = "hidden";


			},
			error : function(data) {
				alert("cancel failed");
			}			

	
		} );


	}

	function showButton(){

		var pincode_text = document.getElementById('pincode_text');
		pincode_text.style.visibility = "visible";

		var aut_pincode = document.getElementById('aut_pincode');
		aut_pincode.style.visibility = "visible";


	}

	function autPincode(){


		var pincode_text = document.getElementById('pincode_text').value;
		var purchase_id = '{{last_activity.7}}';

		$.ajax({
			type: "POST",
			url:"/aut_pincode/",



			data: { 'csrfmiddlewaretoken': '{{csrf_token}}', 'pincode':pincode_text, 'purchase_id':purchase_id}, 
			dataType: 'json',
			async: false,
			success : function(data) {

				if (data.msg == "Pincode correct!"){

					alert("Pincode correct!");

					document.getElementById('status').innerHTML = "done";


					var cancle_button = document.getElementById('cancel_button');
					cancle_button.style.visibility = "hidden";

			



				} else {
					alert("Pincode incorrect!");
				}

			},
			error : function(data) {
				alert("fail");
			}			

	
		} );



	}
	

</script>


</body>


<footer>
	<p>Find your spot</p>
</footer>

</html>
