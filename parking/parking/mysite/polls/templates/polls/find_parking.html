
<!DOCTYPE html>
<html>
<head>
  <title>Find Parking</title>

	<script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.2.1.min.js"></script>


	{% load static %}

  	<link rel="stylesheet" type="text/css" href="{% static "polls/_css/HotSpot.css" %}">
  	<link rel="stylesheet" type="text/css" href="{% static "polls/_css/find_parking.css" %}">
      <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
      <meta charset="utf-8">
</head>

<body>
  <div class="all_site">
      <header>
          <div class="logo">
		{% load static %}
              	<img src="{% static "_images/cars.jpg" %}" height="49"/>          
          </div>  
          <nav>
              <ul>
                  <a href="{% url 'polls:call_history' %}"><li>My History</li></a>
                  <a href="{% url 'polls:homepage' %}"><li>Home Page</li></a>
              </ul>
          </nav>
      
          <!-- background picture define in find_parking.css -->
          <div class="back"></div>
          <div id="floating-panel">
		<input id="address" type="textbox" value="Tel Aviv">
		<input id="find_parking" type="button" value="Find Parking"><br>
		<input id="radius" type="textbox" value="100"><font color="white"> meters</font><br>
		<select id='minutes' name = 'minutes'> +
			<option value=5 SELECTED >5 min</option>
			<option value=10>10 min</option>
			<option value=15>15 min</option>
			<option value=20>20 min</option>
			<option value=25>25 min</option>
			<option value=30>30 min</option>

		</select>




            </div>

                <!-- the map windoe --> 
             <div id="map"></div>
                    

                    </header>
                    <script>
                        var marker;
                        var infoWindow;

			function update_spots_on_map(lat, lng, radius, minutes) {

				$.ajax({
					type: "POST",
					url:"/update_spots_on_map/",
					data: { 'csrfmiddlewaretoken': '{{csrf_token}}', 'lat':lat, 'lng':lng, 'radius':radius, 						'minutes':minutes }, 
        				dataType: 'json',
					async: false,
        				success : function(data) {

            					alert(data.relevant_parkings);
            					alert(data.relevant_free_parkings);

        				},
					error : function(data) {
						alert("fail");
					}			
		
			
				} );
			}


                        function initMap(){
                            //map options

                            var mapCanvas = document.getElementById("map");
                            var myCenter = new google.maps.LatLng(32.121678, 34.791143);
                            var mapOptions = {center: myCenter, zoom: 14};
                        
                            //new map
                            var map = new google.maps.Map(mapCanvas,mapOptions);
                            
                            var geocoder = new google.maps.Geocoder();
                            document.getElementById('find_parking').addEventListener('click', function() {

                            	geocodeAddress(geocoder, map);

                            });
    


                            // Array off markers- Parking spaces published
                            //TODO: how to get coords from database  
                            var markers = [
                                {
                                    coords:{lat:32.121678, lng:34.873},
                                    content : '<h1>Adam sendler rating:269</h1>'
                                },
                                {
                                    coords:myCenter,
                                    content : '<h1>the center of the map</h1>'
                                }
                            ];              
                        
                            //loop to add -markers
                            for(var i = 0;i < markers.length;i++){
                                addMarker(markers[i]);
                            }

                            //add marker function
                            function addMarker(props){

                                marker = new google.maps.Marker({
                                position: props.coords,
                                map:map
                                //TODO if we want change image of marker
                                //icon
                                });

                                
                                //TODO Add the seller's name and rating
                                infoWindow = new google.maps.InfoWindow({
                                    content:  props.content
                                });

                                marker.addListener('click', function() {
                                    infoWindow.open(map, marker);
                                }); 
                                
                                
                            }
                            if (navigator.geolocation) {
                                navigator.geolocation.getCurrentPosition(function(position) {
                                  var pos = {
                                  lat: position.coords.latitude,
                                  lng: position.coords.longitude
                                  };

                                  infoWindow.setPosition(pos);
                                  infoWindow.setContent('Location found.');
                                  infoWindow.open(map);
                                  map.setCenter(pos);
                              }, function() {
                                  handleLocationError(true, infoWindow, map.getCenter());
                              });
                            } else {
                            // Browser doesn't support Geolocation
                            handleLocationError(false, infoWindow, map.getCenter());
                            }
                        } // End initMap function

                        function geocodeAddress(geocoder, resultsMap) {
				var address = document.getElementById('address').value;
				var radius = document.getElementById('radius').value;
				var minutes = document.getElementById('minutes').value;
		    		geocoder.geocode({'address': address}, function(results, status) {
		               	if (status === 'OK') {

					var location = results[0].geometry.location;
				        resultsMap.setCenter(location);

					var lat = location.lat();
					var lng = location.lng();

					var list_of_spots = update_spots_on_map(lat, lng, radius, minutes);



                                // var marker = new google.maps.Marker({
                                // map: resultsMap,
                                //position: results[0].geometry.location
                                //});
		             	} else {
		                	alert('Geocode was not successful for the following reason: ' + status);
		               	}
                          });
                        }
                        function handleLocationError(browserHasGeolocation, infoWindow, pos) {
                            infoWindow.setPosition(pos);
                            infoWindow.setContent(browserHasGeolocation ?
                                                'Error: The Geolocation service failed.' :
                                                'Error: Your browser doesn\'t support geolocation.');
                            infoWindow.open(map);
                        }
                        </script>
                        
                        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAIn9K5Niimp_WDiNC8ckPUcKdi_RxYLHM&language=en&callback=initMap"></script>
                        
                    <!--<footer>
                        find your spot
                    </footer> -->  
                    <p class="clear"></p>  

                </div>  
            </body>
            </html>
